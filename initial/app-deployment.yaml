#apiVersion: apps/v1
#kind: Deployment
#metadata:
#  name: demo-app-spring
#  labels:
#    app: demo-app-spring
#spec:
#  replicas: 1
#  selector:
#    matchLabels:
#      app: demo-app-spring
#  template:
#    metadata:
#      labels:
#        app: demo-app-spring
#    spec:
#      containers:
#        - name: demo-app-spring
#          image: 557690581666.dkr.ecr.eu-west-1.amazonaws.com/spring-batch-eks:latest
#          imagePullPolicy: IfNotPresent
#          ports:
#            - name: http
#              containerPort: 8080
#          resources:
#            limits:
#              cpu: 0.2
#              memory: "200Mi"
#          env:
#            - name: DB_PASSWORD
#              valueFrom:
#                secretKeyRef:
#                  name: mysql-pass
#                  key: mysql-user-password
#            - name: DB_SERVER
#              valueFrom:
#                configMapKeyRef:
#                  name:  mysql-config-map
#                  key: mysql-server
#            - name: DB_NAME
#              valueFrom:
#                configMapKeyRef:
#                  name:  mysql-config-map
#                  key: mysql-database-name
#            - name: DB_USERNAME
#              valueFrom:
#                configMapKeyRef:
#                  name: mysql-config-map
#                  key: mysql-user-username
#
#---
#apiVersion: v1
#kind: Service
#metadata:
#  name: demo-app-spring
#  labels:
#    app: demo-app-spring
#spec:
#  type: LoadBalancer
#  selector:
#    app: demo-app-spring
#  ports:
#    - protocol: TCP
#      name: http
#      port: 8080
#      targetPort: 8080
#      nodePort: 30000


#apiVersion: batch/v1
#kind: Job
#metadata:
#  name: batch-job
#spec:
#  template:
#    spec:
#      restartPolicy: OnFailure
##      initContainers:
##        - name: init-db
##          image: mysql:5.6
##          command: [ 'sh', '-c', 'mysql -h $DB_SERVER -u$DB_USERNAME -p$DB_PASSWORD $DB_NAME < /scripts/schema.sql' ]
###          command: ["sh", "-c", "echo DB_SERVER=$DB_SERVER DB_USERNAME=$DB_USERNAME DB_PASSWORD=$DB_PASSWORD DB_NAME=$DB_NAME && sleep 300"]
##          env:
##            - name: DB_SERVER
##              valueFrom:
##                configMapKeyRef:
##                  name: mysql-config-map
##                  key: mysql-server
##            - name: DB_USERNAME
##              valueFrom:
##                configMapKeyRef:
##                  name: mysql-config-map
##                  key: mysql-user-username
##            - name: DB_PASSWORD
##              valueFrom:
##                secretKeyRef:
##                  name: mysql-pass
##                  key: mysql-user-password
##            - name: DB_NAME
##              valueFrom:
##                configMapKeyRef:
##                  name: mysql-config-map
##                  key: mysql-database-name
##          volumeMounts:
##            - name: init-sql-volume
##              mountPath: /scripts
##              readOnly: true
#      containers:
#        - name: demo-app-spring
#          image:  ${IMAGE}
##          image: 557690581666.dkr.ecr.eu-west-1.amazonaws.com/spring-batch-eks:latest
#          imagePullPolicy: IfNotPresent
#          env:
#            - name: SPRING_DATASOURCE_URL
##              value: jdbc:mysql://$(DB_SERVER):3306/$(DB_NAME)?useSSL=false&allowPublicKeyRetrieval=true
#              value: jdbc:mysql://demo-app-mysql.default.svc.cluster.local:3306/batch_process?useSSL=false&allowPublicKeyRetrieval=true
##            - name: DB_PASSWORD
##              valueFrom:
##                secretKeyRef:
##                  name: mysql-pass
##                  key: mysql-user-password
#            - name: SPRING_DATASOURCE_USERNAME
#              valueFrom:
#                configMapKeyRef:
#                  name: mysql-config-map
#                  key: mysql-user-username
#            - name: SPRING_DATASOURCE_PASSWORD
#              valueFrom:
#                secretKeyRef:
#                  name: mysql-pass
#                  key: mysql-user-password
##            - name: DB_SERVER
##              valueFrom:
##                configMapKeyRef:
##                  name:  mysql-config-map
##                  key: mysql-server
##            - name: DB_NAME
##              valueFrom:
##                configMapKeyRef:
##                  name:  mysql-config-map
##                  key: mysql-database-name
##            - name: DB_USERNAME
##              valueFrom:
##                configMapKeyRef:
##                  name: mysql-config-map
##                  key: mysql-user-username
##      volumes:
##        - name: init-sql-volume
##          configMap:
##            name: init-sql-script


apiVersion: batch/v1
kind: CronJob
metadata:
  name: batch-job
spec:
  schedule: "*/5 * * * *"
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: demo-app-spring
              image: ${IMAGE}
              imagePullPolicy: IfNotPresent
              env:
                - name: SPRING_DATASOURCE_URL
                  value: jdbc:mysql://demo-app-mysql.default.svc.cluster.local:3306/batch_process?useSSL=false&allowPublicKeyRetrieval=true
                - name: SPRING_DATASOURCE_USERNAME
                  valueFrom:
                    configMapKeyRef:
                      name: mysql-config-map
                      key: mysql-user-username
                - name: SPRING_DATASOURCE_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: mysql-pass
                      key: mysql-user-password
